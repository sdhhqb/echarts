<!DOCTYPE html>
<html lang="en">
	<head>
	<meta charset="utf-8">
	<title>pie</title>
	<style>
		html, body {
		background-color: #3f475e;
		}
		#chart {
		width: 500px;
		height: 500px;
		border: solid 1px #ccc;
		}
	</style>
	<script src="../dist/echarts.custom.js"></script>
	</head>
	<body>
	<div id="chart"></div>

	<script>
	var i;
	function toRgba (color, opacity) {
		var rgba = color.replace(/^#/g, '');
		if (rgba.length == 3) {
			rgba = rgba.split('');
			for (i = 0; i < rgba.length; i++) {
				rgba[i] += rgba[i];
			}
			rgba = rgba.join('');
		}
		if (rgba.length != 6) {
			rgba = '';
		} else {
			rgba = 'rgba(' + parseInt(rgba.substring(0,2), 16) + ',' +
				parseInt(rgba.substring(2,4), 16) + ',' +
				parseInt(rgba.substring(4,6), 16) + ',' + opacity + ')';
		}
		return rgba;
	}
	var colors = ['#7fa3df','#7bdda7','#f5e58e','#f195bc'];
	var data = {
		"level1": [
			{"value":700, "name":"品牌","info":"brand","label": {"normal": {"show": true}}},
			{"value":500, "name":"产品产品","info":"product","label": {"normal": {"show": true}}},
			{"value":300, "name":"功能功能功能","info":"feature","label": {"normal": {"show": true}}},
			{"value":200, "name":"服务服务服务服务","info":"service","label": {"normal": {"show": true}}}
		],
		"level2": {
			"brand": [
			{"value":335, "name":"论坛"},
				{"value":310, "name":"电商"},
				{"value":234, "name":"权威网站"},
				{"value":135, "name":"微博"}
			],
			"product": [
			{"value":335, "name":"论坛"},
				{"value":310, "name":"电商"},
				{"value":234, "name":"权威网站"},
				{"value":135, "name":"微博"}
			],
			"feature": [
			{"value":335, "name":"论坛"},
				{"value":310, "name":"电商"},
				{"value":234, "name":"权威网站"},
				{"value":135, "name":"微博"}
			],
			"service": [
			{"value":335, "name":"论坛"},
				{"value":310, "name":"电商"},
				{"value":234, "name":"权威网站"},
				{"value":135, "name":"微博"}
			]
		}
	};
	// 二级环形图四种不同颜色
	var se2_color = [
		[
			{value:335, name:'论坛',itemStyle:{normal:{color: '#7fa3df'}}},
			{value:310, name:'电商',itemStyle:{normal:{color: '#6f95d4'}}},
			{value:234, name:'权威网站',itemStyle:{normal:{color: '#638ac9'}}},
			{value:135, name:'微博',itemStyle:{normal:{color: '#567dbb'}}}
		],
		[
			{value:335, name:'论坛',itemStyle:{normal:{color: '#7bdda7'}}},
			{value:310, name:'电商',itemStyle:{normal:{color: '#5ec38b'}}},
			{value:234, name:'权威网站',itemStyle:{normal:{color: '#4db079'}}},
			{value:135, name:'微博',itemStyle:{normal:{color: '#40a16b'}}}
		],
		[
			{value:335, name:'论坛',itemStyle:{normal:{color: '#f5e58e'}}},
			{value:310, name:'电商',itemStyle:{normal:{color: '#ead16d'}}},
			{value:234, name:'权威网站',itemStyle:{normal:{color: '#d9ba59'}}},
			{value:135, name:'微博',itemStyle:{normal:{color: '#d8b139'}}}
		],
		[
			{value:335, name:'论坛',itemStyle:{normal:{color: '#f195bc'}}},
			{value:310, name:'电商',itemStyle:{normal:{color: '#ec81ae'}}},
			{value:234, name:'权威网站',itemStyle:{normal:{color: '#e3679b'}}},
			{value:135, name:'微博',itemStyle:{normal:{color: '#dd528d'}}}
		]
	];

	var myChart = echarts.init(document.getElementById('chart'));
	var chartRef = myChart;

	var option = {
		color: ['#7fa3df','#7bdda7','#f5e58e','#f195bc'],
		tooltip: {
				// position: 'inside',
				enterable: true,
			trigger: 'item',
			formatter: '{a} <br/>{b}: {c} ({d}%)'
		},
		legend: {
			orient: 'vertical',
			x: 'left',
			data:[
			 {
        	name:'品牌',
        	icon: 'circle'
        },
        {
        	name:'产品',
        	icon: 'circle'
        },
        {
        	name:'功能',
        	icon: 'circle'
        },
        {
        	name:'服务',
        	icon: 'circle'
        }
      ],
      textStyle: {
      	color: '#fff'
      }
		},
		series: [
			{
				name:'类别',
				type:'pie',
				selectedMode: 'single',
				radius: ['25%', '35%'],

				label: {
					normal: {
						position: 'circle-center',
						textStyle: {
							color: '#fff'
						}
					}
				},
				data:[
					{value:700, name:'品牌', 
						label: {normal: {show: true}}
					},
					{value:500, name:'产品',
						label: {normal: {show: true}}
					},
					{value:300, name:'功能', 
						label: {normal: {show: true}}
					},
					{value:200, name:'服务',
						label: {normal: {show: true}}
					}
				]
			}
		]
	};

	for (i = 0; i < data.level1.length; i++) {
		data.level1[i].label.normal.addBtnColor = toRgba(colors[i], 0.5);
	}
	
			
	function drawChart (data) {
		option.series[0].data = data.level1;
		chartRef.setOption(option);
		level2_data = data.level2;
		// 选择扇区改变事件
		chartRef.on('pieselectchanged', handleSelectChg);
	}
	drawChart(data);

	function handleSelectChg (event) {
		var curSelNm = event.name;
		var se1 = option.series[0];
		var se1_data = se1.data;
		var i, curIndex = 0, foundCur = false, cur = 0, total = 0;
		var start_angle = 90;
		var curCate = '';

		var hasSelected = false;
		// debugger;
		// return;
		// 有选中，设置选中项的label显示，设置选中状态表
		for (i = 0; i < se1_data.length; i++) {
			if (event.selected[se1_data[i].name]) {
				hasSelected = true;
			}
			se1_data[i].label.normal.show = event.selected[se1_data[i].name];
			se1_data[i].selected = event.selected[se1_data[i].name];
		}
		// 如果没有选中，设置所有的label都显示
		if (!hasSelected) {
			for (i = 0; i < se1_data.length; i++) {
				se1_data[i].label.normal.show = true;
			}
		}
		chartRef.setOption(option, true);
		// return ;
		
		// 如果有选中，计算二级圆环的起始角度
		if (hasSelected) {
		for (i = 0; i < se1_data.length; i++) {
					option.series[0].data[i].selected = false;
					if (se1_data[i].name == curSelNm) {
						foundCur = true;
						option.series[0].data[i].selected = true;
						curIndex = i;
						curCate = option.series[0].data[i].info;
					}
					if (!foundCur) {
						cur += se1_data[i].value;
					}
					total += se1_data[i].value;
				}
				start_angle = start_angle - (360 * cur / total);
				if (start_angle < 0) {
					start_angle += 360;
				}   
		}
			
			for (i = 1; i < option.series.length; i++) {
				option.series.pop();
			}

			chartRef.setOption(option, true);

			// return ;


			if (!hasSelected) {
				return;
			}

			var level2 = level2_data[curCate];
			for (var j = 0; j < level2.length; j++) {
				level2[j].itemStyle = se2_color[curIndex][j].itemStyle;
			}
			
		option.series.push(
			{
				name:curSelNm,
				type:'pie',
				label: {
					normal: {
						position: 'right-angle',
						formatter: '{b}\n{c}\n{d}%'						
					}
				},
				labelLine: {
					normal: {
						length: 0,
						length2: 50
					}
				},
				itemStyle: {
					normal: {
						color: colors[curIndex]
					}
				},
				radius: ['45%', '55%'],
				startAngle: start_angle,

				data:level2
			}
		);
		chartRef.setOption(option, true);   

	}

	</script>
	</body>
</html>